{% extends "ca/base.html" %}
{% block content %}

<!-- Back to client -->
<div class="ca-breadcrumb">
    <a href="/ca/clients/{{ client.id }}">{{ client.name }}</a> &rsaquo; AI Insights
</div>

<!-- AI Insights -->
<section class="ca-section">
    <h2>AI-Powered Tax Insights</h2>
    <p class="ca-text-muted">Generated by GPT-4o based on {{ client.name }}'s invoice data (last 12 months)</p>

    <div class="ca-insights-card">
        <div class="ca-insights-content">
            {{ insights | replace('\n', '<br>') | safe }}
        </div>
    </div>
</section>

<!-- Quick Summary -->
{% if summary %}
<section class="ca-section">
    <h2>Quick Summary</h2>
    <div class="ca-stats-grid">
        <div class="ca-stat-card">
            <div class="ca-stat-value">{{ summary.total_invoices }}</div>
            <div class="ca-stat-label">Total Invoices</div>
        </div>
        <div class="ca-stat-card">
            <div class="ca-stat-value">{{ "%.2f"|format(summary.total_taxable_value) }}</div>
            <div class="ca-stat-label">Taxable Value</div>
        </div>
        <div class="ca-stat-card">
            <div class="ca-stat-value">{{ "%.2f"|format(summary.total_tax) }}</div>
            <div class="ca-stat-label">Total Tax</div>
        </div>
    </div>
</section>
{% endif %}

<!-- Anomaly Summary -->
{% if anomalies %}
<section class="ca-section">
    <h2>Anomaly Summary</h2>
    <div class="ca-detail-grid">
        <div class="ca-detail-item">
            <span class="ca-detail-label">Duplicate Invoices</span>
            <span class="ca-detail-value {{ 'ca-text-danger' if anomalies.duplicate_invoice_numbers else 'ca-text-success' }}">
                {{ anomalies.duplicate_invoice_numbers | length }}
            </span>
        </div>
        <div class="ca-detail-item">
            <span class="ca-detail-label">Invalid GSTINs</span>
            <span class="ca-detail-value {{ 'ca-text-danger' if anomalies.invalid_gstins else 'ca-text-success' }}">
                {{ anomalies.invalid_gstins | length }}
            </span>
        </div>
        <div class="ca-detail-item">
            <span class="ca-detail-label">High Value Outliers</span>
            <span class="ca-detail-value {{ 'ca-text-warning' if anomalies.high_value_invoices else 'ca-text-success' }}">
                {{ anomalies.high_value_invoices | length }}
            </span>
        </div>
        <div class="ca-detail-item">
            <span class="ca-detail-label">Unusual Tax Rates</span>
            <span class="ca-detail-value {{ 'ca-text-warning' if anomalies.unusual_tax_rates else 'ca-text-success' }}">
                {{ anomalies.unusual_tax_rates | length }}
            </span>
        </div>
    </div>
</section>
{% endif %}

<div class="ca-form-actions" style="margin-top: 24px;">
    <a href="/ca/clients/{{ client.id }}/analytics" class="ca-btn ca-btn-primary">View Full Analytics</a>
    <a href="/ca/clients/{{ client.id }}" class="ca-btn ca-btn-outline">Back to Client</a>
</div>

{% endblock %}
